# 文档自动提取关键信息系统设计思路

## 一、系统概述

本系统旨在自动处理本地文档（Word、PDF），识别文档类型，提取关键信息，并将结果存储到对应的Excel表格中。系统使用OpenAI接口调用Qwen大模型进行文档分类和关键信息提取。

## 二、核心功能模块

### 1. 文档读取模块（Document Reader）
- **功能**：扫描data目录，读取所有Word和PDF文件
- **技术选型**：
  - Word文件：使用`python-docx`库
  - PDF文件：使用`PyPDF2`或`pdfplumber`库
- **输出**：文档文本内容（纯文本，不含图片）

### 2. 文档分类模块（Document Classifier）
- **功能**：识别文档类型（办会材料信息、办文材料信息、政策文件信息）
- **实现策略**：
  - **完全使用LLM分类**：所有文档分类任务都交给Qwen大模型处理，确保分类准确性
  - **智能判断**：通过精心设计的Prompt，让LLM理解文档内容并准确分类
- **分类逻辑**：
  1. 读取文档内容后，直接调用LLM进行分类
  2. LLM分析文档内容，判断属于：办会材料信息、办文材料信息、政策文件信息
  3. 返回分类结果，用于后续的信息提取流程

### 3. 信息提取模块（Information Extractor）
- **功能**：根据文档类型，提取对应的关键信息字段
- **实现方式**：
  - 使用Qwen大模型进行结构化信息提取
  - 通过Prompt Engineering设计提取模板
  - 返回JSON格式的结构化数据
- **提取字段**：
  - 办会材料：ID、PolicyCategory、PolicyFileName、IssuingAuthority、EffectiveDate、Position、Topic、Refrence、Remarks
  - 办文材料：ID、PolicyCategory、PolicyFileName、IssuingAuthority、EffectiveDate、Position、ObjectOriented、Topic、Refrence、Language、Remarks
  - 政策文件：ID、PolicyCategory、PolicyFileName、DocumentNumber、IssuingAuthority、EffectiveDate、ImplementationDate、ValidUntil、ResponsibleDepartment、CollaborativeDepartment、ApplicableObject、Fields、Remarks
  - 政策问答对：XH、ID、SourceDepartment、Problem、Answer、PolicyName、DocumentNumber、Fields、Remarks

### 4. 数据存储模块（Data Storage）
- **功能**：将提取的信息写入对应的Excel文件
- **技术选型**：使用`openpyxl`或`pandas`库操作Excel
- **存储逻辑**：
  - 根据文档类型，写入对应的Excel模板文件
  - 支持追加模式，避免覆盖已有数据
  - 自动生成序号（ID）

## 三、技术架构

### 1. 依赖管理
**使用 Conda + pyproject.toml 组合**：
- **Conda**：仅负责 Python 版本环境管理（Python 3.11）
- **pyproject.toml**：负责所有项目依赖的管理和版本控制
- **environment.yml**：仅包含 Python 版本配置，用于创建 conda 环境

**依赖管理原则**：
1. **Conda 只管理 Python 版本**：使用 conda 创建 Python 3.11 环境
2. **pyproject.toml 管理所有依赖**：所有 Python 包依赖通过 pyproject.toml 定义，使用 pip 安装
3. **单一管理模式**：不区分开发和生产环境，统一使用 pyproject.toml

**主要依赖库**（在 pyproject.toml 中定义）：
- `python-docx>=1.1.2`：处理Word文档
- `pdfplumber>=0.11.4`：处理PDF文档
- `openai>=1.54.0`：调用Qwen大模型API（兼容OpenAI接口）
- `openpyxl>=3.1.5`：操作Excel文件
- `pandas>=2.2.2`：数据处理
- `python-dotenv>=1.0.1`：管理环境变量

**安装方式**：
```bash
# 1. 使用 conda 创建 Python 环境
conda env create -f environment.yml
conda activate big-data-doc-auto-shell

# 2. 使用 pip 安装项目依赖（从 pyproject.toml）
pip install -e .
```

### 2. 项目结构
```
BigDataDocAutoShell/
├── data/                    # 待处理文档目录
├── template/                # Excel模板文件目录
├── src/
│   ├── document_reader.py   # 文档读取模块
│   ├── document_classifier.py  # 文档分类模块
│   ├── information_extractor.py  # 信息提取模块
│   ├── data_storage.py      # 数据存储模块
│   └── config.py           # 配置文件
├── main.py                  # 主程序入口
├── pyproject.toml          # 项目元数据和依赖管理（所有依赖定义在此）
├── environment.yml         # Conda 环境配置文件（仅包含 Python 3.11 版本）
├── .env.example            # 环境变量模板文件
├── .env                     # 环境变量（API密钥，需自行创建，已加入.gitignore）
└── .gitignore              # Git忽略文件配置
```

## 四、实现流程

### 主流程
1. **初始化**：加载配置、检查data目录和template目录
2. **文档扫描**：遍历data目录，获取所有Word和PDF文件列表
3. **文档处理循环**（带进度条显示）：
   - 读取文档内容（文本提取）
   - 文档分类（调用LLM）
   - 信息提取（调用LLM）
   - 数据验证和清洗
   - 写入Excel
   - 更新进度条（显示当前进度百分比）
4. **结果汇总**：输出处理统计信息（成功数量、失败数量、总耗时等）

### 详细流程

```
开始
  ↓
扫描data目录 → 获取文件列表
  ↓
显示启动信息（文件总数、配置信息）
  ↓
初始化进度条（tqdm，总数=文件数）
  ↓
遍历每个文件（带进度条）
  ↓
显示当前文件：[1/10] [读取] 文件名.docx
  ↓
读取文档内容（Word/PDF → 文本）
  ↓
显示状态：[1/10] [分类] 文件名.docx
  ↓
调用LLM进行文档分类
  ├─ 办会材料信息（会议通知、会议方案、会议纪要等）
  ├─ 办文材料信息（工作总结、工作报告、工作要点等）
  └─ 政策文件信息（政策文件、法规文件等）
  ↓
显示状态：[1/10] [提取] 文件名.docx
  ↓
根据分类结果，调用对应的信息提取Prompt
  ↓
调用Qwen大模型提取关键信息
  ↓
解析返回的JSON数据
  ↓
数据验证和清洗（检查必填字段、格式校验）
  ↓
显示状态：[1/10] [保存] 文件名.docx
  ↓
写入对应的Excel文件（追加模式）
  ↓
显示成功：[1/10] [成功] 文件名.docx → 分类结果
  ↓
更新进度条（进度+1，更新百分比、ETA）
  ↓
下一个文件
  ↓
处理完成，输出统计信息（成功数、失败数、总耗时等）
```

## 五、LLM Prompt设计

### 1. 文档分类Prompt
```
你是一个专业的文档分类专家。请仔细分析以下文档内容，判断它属于以下哪种类型：

类型说明：
1. 办会材料信息：包括会议通知、会议方案、会议纪要、会议安排等与会议相关的文档。这类文档通常包含会议时间、地点、参会人员、会议议题等内容。

2. 办文材料信息：包括工作总结、工作报告、工作要点、交流谈话、工作调研、工作要求等日常工作文档。这类文档通常涉及工作汇报、工作安排、工作交流等内容。

3. 政策文件信息：包括政策文件、法规文件、规范性文件、政策解读等政策性文档。这类文档通常涉及政策规定、法规条文、政策解读等内容。

文档内容：
{文档内容}

请仔细分析文档的内容特征、格式特征和用途，准确判断文档类型。
请只返回类型编号（1、2或3），不要返回其他任何内容。
```

### 2. 信息提取Prompt（以办会材料为例）
```
你是一个信息提取专家。请从以下文档中提取关键信息，并以JSON格式返回。

文档内容：
{文档内容}

请提取以下字段：
- PolicyCategory（文件类别）：会议通知、会议方案、会议纪要、其他
- PolicyFileName（文件名称）：文档的完整名称
- IssuingAuthority（所属单位）：发文单位
- EffectiveDate（成文日期）：格式为YYYY-MM-DD
- Position（会议层级）：科级、处级、局级（地厅级）、省部级、国家级
  注意：重庆是直辖市，行政级别与其他市不同。重庆市级会议相当于省部级，重庆区级会议相当于局级（地厅级），重庆区级部门会议相当于处级，重庆街道/镇级会议相当于科级。
- Topic（主题分类）：社会服务与治理、食品药品安全、教育、卫生健康与医疗、商务、经济与金融、环境保护与生态文明、创新创业发展、农业农村发展、工业和信息化、文化与旅游、城市建设与规划、国家能源发展与规划、网络与信息安全、国际交流与合作、交通管理与规划、其他
- Refrence（参考资料）：如有参考资料请提取，否则为空
- Remarks（备注）：其他需要备注的信息

请严格按照以下JSON格式返回，不要添加任何其他文字：
{
  "PolicyCategory": "",
  "PolicyFileName": "",
  "IssuingAuthority": "",
  "EffectiveDate": "",
  "Position": "",
  "Topic": "",
  "Refrence": "",
  "Remarks": ""
}
```

## 六、关键技术点

### 1. 文档读取
- Word：使用`python-docx`逐段读取文本
- PDF：使用`pdfplumber`提取文本，处理可能的编码问题

### 2. 文本预处理
- 去除多余空白字符
- 统一换行符
- 处理特殊字符
- 限制文本长度（避免超出LLM token限制）

### 3. 错误处理
- 文件读取失败：记录日志，跳过该文件
- LLM调用失败：重试机制（最多3次）
- 数据提取失败：记录错误，继续处理下一个文件
- Excel写入失败：回滚操作

### 4. 进度显示和命令行输出
- **使用 tqdm 库**：显示处理进度条和百分比
- **进度计算**：基于已处理文件数 / 总文件数
- **命令行显示信息**：
  - 程序启动信息：显示扫描到的文件总数
  - 当前处理的文件名（实时更新）
  - 进度条显示：
    - 已处理数量 / 总数量
    - 进度百分比（%）
    - 预计剩余时间（ETA）
    - 处理速度（文件/秒）
  - 每个文件的处理状态：
    - 正在读取：`[读取] 文件名.docx`
    - 正在分类：`[分类] 文件名.docx`
    - 正在提取：`[提取] 文件名.docx`
    - 正在保存：`[保存] 文件名.docx`
    - 处理成功：`[成功] 文件名.docx → 办会材料信息`
    - 处理失败：`[失败] 文件名.docx - 错误信息`
- **更新时机**：每个文件处理完成后更新进度条
- **最终统计**：处理完成后显示汇总信息（成功数、失败数、总耗时等）

### 5. 性能优化
- 批量处理：可以考虑批量调用LLM（如果API支持）
- 缓存机制：相同文档内容不重复处理
- 并发处理：使用多线程/异步处理多个文件（注意API限流）

## 七、配置管理

### 环境变量（.env）
```
# OpenAI API 配置（兼容 Qwen 大模型）
OPENAI_API_KEY=sk-9657a9f9fabe4430b659abd19c32a8f2
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
MODEL_NAME=qwen3-30b-a3b-instruct-2507

# API 请求配置
MAX_RETRIES=3
REQUEST_TIMEOUT=60

# 项目路径配置（可选）
DATA_DIR=data
TEMPLATE_DIR=template
OUTPUT_DIR=output
```

**注意**：项目根目录已包含 `.env` 文件，包含实际的API配置。`.env.example` 文件作为模板供参考。

### 配置文件（config.py）
```python
DATA_DIR = "data"
TEMPLATE_DIR = "template"
OUTPUT_DIR = "output"  # 输出Excel目录

# Excel模板文件映射
TEMPLATE_MAPPING = {
    "办会材料信息": "2办会材料信息.xlsx",
    "办文材料信息": "3办文材料信息.xlsx",
    "政策文件信息": "4政策文件信息.xlsx",
    "政策问答对": "5政策问答对.xlsx"
}
```

## 八、数据验证规则

### 1. 字段格式验证
- EffectiveDate：日期格式验证（YYYY-MM-DD）
- 枚举字段：验证是否在允许的值列表中
- 必填字段：检查是否为空

### 2. 数据清洗
- 去除前后空格
- 统一日期格式
- 处理特殊字符
- 规范化单位名称（如"各区级单位、镇街"）

## 九、日志和监控

### 1. 命令行实时输出
- **启动信息**：显示程序版本、配置信息、扫描到的文件数量
- **实时进度显示**：
  ```
  正在处理文档...
  总文件数: 10
  
  [1/10] [读取] 关于协调爱心亭接电用电事宜的函.docx
  [1/10] [分类] 关于协调爱心亭接电用电事宜的函.docx
  [1/10] [提取] 关于协调爱心亭接电用电事宜的函.docx
  [1/10] [保存] 关于协调爱心亭接电用电事宜的函.docx
  [1/10] [成功] 关于协调爱心亭接电用电事宜的函.docx → 办文材料信息
  
  进度: 10%|█         | 1/10 [00:15<02:15, 15.2s/文件]
  ```

- **进度条格式**：
  - 显示当前文件名
  - 显示进度百分比
  - 显示已处理/总数
  - 显示处理速度
  - 显示预计剩余时间

### 2. 日志记录
- 使用`logging`模块记录处理过程到日志文件
- 记录每个文件的处理状态（成功/失败）
- 记录详细的错误信息（用于调试）

### 3. 最终统计报告
处理完成后在命令行输出：
```
========================================
处理完成！
========================================
总文件数: 10
成功处理: 9
失败: 1
总耗时: 2分35秒
平均速度: 3.8 文件/分钟

失败文件:
  - 文件A.docx: 错误信息...

输出文件:
  - 办会材料信息.xlsx: 3条记录
  - 办文材料信息.xlsx: 4条记录
  - 政策文件信息.xlsx: 2条记录
========================================
```

## 十、扩展性考虑

1. **支持更多文档类型**：可扩展文档分类逻辑
2. **支持图片文档**：未来可集成OCR功能
3. **Web界面**：可开发Web界面进行可视化操作
4. **数据库存储**：可扩展为数据库存储而非Excel
5. **增量更新**：支持只处理新增文件

## 十一、项目安装和使用

### 1. 环境准备（使用 Conda + pyproject.toml）

**重要说明**：
- **Conda**：仅负责创建和管理 Python 3.11 环境
- **pyproject.toml**：负责所有项目依赖的管理，使用 pip 安装
- **单一模式**：不区分开发和生产环境，统一使用 pyproject.toml 管理依赖

**安装步骤**：
```bash
# 1. 配置 pip 使用阿里云镜像源（已自动配置，加速下载）
# 配置文件位置：~/.pip/pip.conf
# 内容：
# [global]
# index-url = https://mirrors.aliyun.com/pypi/simple/
# trusted-host = mirrors.aliyun.com

# 2. 使用 conda 创建 Python 3.11 环境
conda env create -f environment.yml

# 3. 激活环境
conda activate big-data-doc-auto-shell

# 4. 使用 pip 安装项目依赖（从 pyproject.toml 读取，使用阿里云源）
pip install -e .
```

**手动创建方式**（可选）：
```bash
# 创建 conda 环境，指定 Python 3.11
conda create -n big-data-doc-auto-shell python=3.11

# 激活环境
conda activate big-data-doc-auto-shell

# 安装项目依赖（从 pyproject.toml）
pip install -e .
```

**验证环境**
```bash
# 检查 Python 版本（应为 3.11.x）
python --version

# 检查 conda 环境
conda env list

# 查看已安装的包
pip list
```

### 2. 配置环境变量
项目已包含 `.env.example` 模板文件。创建 `.env` 文件并配置：

**方式一：复制模板文件**
```bash
cp .env.example .env
# 然后编辑 .env 文件，填入实际的 API Key
```

**方式二：手动创建 `.env` 文件**
```bash
# OpenAI API 配置（兼容 Qwen 大模型）
OPENAI_API_KEY=sk-9657a9f9fabe4430b659abd19c32a8f2
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
MODEL_NAME=qwen3-30b-a3b-instruct-2507

# API 请求配置
MAX_RETRIES=3
REQUEST_TIMEOUT=60

# 项目路径配置（可选）
DATA_DIR=data
TEMPLATE_DIR=template
OUTPUT_DIR=output
```

**注意**：`.env` 文件包含敏感信息，已添加到 `.gitignore`，不会被提交到版本控制系统。

### 3. 运行项目
```bash
python main.py
```

## 十二、实施步骤

1. **第一阶段**：搭建基础框架，实现文档读取功能
2. **第二阶段**：实现文档分类功能（LLM智能分类）
3. **第三阶段**：实现信息提取功能（LLM调用）
4. **第四阶段**：实现Excel存储功能
5. **第五阶段**：完善错误处理、日志、测试
6. **第六阶段**：优化性能和用户体验

