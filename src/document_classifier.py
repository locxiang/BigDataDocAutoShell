"""文档分类模块 - 使用LLM进行文档分类"""
import logging
from typing import Optional
from openai import OpenAI
from src.config import OPENAI_API_KEY, OPENAI_BASE_URL, MODEL_NAME, MAX_RETRIES, REQUEST_TIMEOUT, DOC_TYPE_MAPPING

logger = logging.getLogger(__name__)


class DocumentClassifier:
    """文档分类器"""
    
    # 分类Prompt模板
    CLASSIFICATION_PROMPT = """你是一个专业的文档分类专家。请仔细分析以下文档内容和文件名，判断它属于以下哪种类型：

类型说明：
1. 办会材料信息：专门与会议相关的文档。包括：
   - 会议通知（明确说明要召开会议，包含会议时间、地点、参会人员）
   - 会议方案（会议筹备方案、会议议程安排）
   - 会议纪要（记录会议讨论内容和决议）
   - 会议安排（会议日程、会议流程）
   【核心判断标准】：文件核心内容必须包含"会议"、"会议通知"、"会议纪要"、"会议方案"、"会议安排"等与会议相关的关键词。文档的核心目的是组织、通知或记录会议活动，必须明确涉及"会议"相关内容。如果文档标题、文件名或核心内容中包含"会议"相关词汇，应优先考虑归类为办会材料信息。

2. 办文材料信息：日常行政办公文档和公文。包括：
   - 公文类：函、通知、报告、请示、批复、意见、通报、决定等各类公文
   - 工作文档：工作总结、工作报告、工作要点、工作调研、工作要求
   - 交流文档：交流谈话、工作交流
   - 其他：工作安排、工作部署、工作协调等
   关键特征：用于日常行政办公、工作协调、信息传达、工作汇报等，不涉及会议组织。特别注意：如果文档标题或内容明确是"函"、"通知"（非会议通知）、"报告"等公文类型，应归类为办文材料信息。

3. 政策文件信息：政策性和法规性文档。包括：
   - 政策文件（政策规定、政策意见）
   - 法规文件（法律法规、规章）
   - 规范性文件（行政规范性文件）
   - 政策解读（政策说明、政策解释）
   关键特征：涉及政策制定、法规条文、政策解读等政策性内容。
   【严格必要条件】：归类为政策文件信息（类型3）必须同时满足以下两个条件，缺一不可：
   ① 文档内容涉及政策制定、法规条文、政策解读等政策性内容
   ② 文档中必须明确包含发文文号（可以在文档内容中，也可以在文件名中）
   
   发文文号的定义：
   发文文号是政府机关、企事业单位在正式文件中使用的编号标识，用于标识和追溯正式公文。它不是简单的日期、编号或时间戳。
   
   发文文号的特征：
   - 必须包含发文单位简称（如"津财农"、"洛碛人大"、"石船人发"、"渝府发"等政府机关或单位名称）
   - 必须包含年份（通常用〔〕或[]括起来，如〔2024〕、[2024]）
   - 必须包含编号数字（如95、4、22等）
   - 必须以"号"结尾
   - 是正式公文的编号标识，出现在文件标题附近或文件开头部分
   
   发文文号格式：发文单位简称+年份（用〔〕或[]括起来）+编号+号
   发文文号正确示例：津财农〔2024〕95号、洛碛人大〔2019〕4号、石船人发〔2020〕22号、渝府发〔2024〕10号
   发文文号错误示例（这些不是发文文号）：
   - 2024年、2024-12-25（只是日期，不是文号）
   - 第95号、编号95（只有编号，没有单位简称和年份）
   - 〔2024〕95（缺少"号"字）
   - 95号（只有编号和"号"，缺少单位简称和年份）
   
   【重要】：如果文档内容涉及政策但未找到发文文号（在文档内容和文件名中都找不到），必须归类为"办文材料信息"（类型2），绝对不能归类为政策文件信息。

重要区分原则：
- 【办会材料信息（类型1）的判定流程】：
  步骤1：检查文档标题、文件名或核心内容中是否包含"会议"、"会议通知"、"会议纪要"、"会议方案"、"会议安排"等与会议相关的关键词
  步骤2：如果找到会议相关关键词，检查文档内容是否涉及会议的组织、通知、记录等活动
  步骤3：如果同时满足"有会议关键词"和"内容涉及会议活动"两个条件，归类为办会材料信息（类型1）
  步骤4：如果文档标题或文件名明确包含"会议通知"、"会议纪要"、"会议方案"等，即使内容较少，也应归类为办会材料信息（类型1）
- 如果文档是"函"（如"关于XX的函"），应归类为"办文材料信息"（类型2）
- 如果文档是普通"通知"但内容不涉及会议（标题或内容中没有"会议"关键词），应归类为"办文材料信息"（类型2）
- 【最关键原则】政策文件信息（类型3）的判定流程：
  步骤1：检查文档内容和文件名中是否包含发文文号
      - 发文文号必须同时包含：发文单位简称+年份（〔〕或[]括起来）+编号+号
      - 注意：单独的日期（如2024年、2024-12-25）、单独的编号（如第95号、编号95）、只有年份和编号但没有单位简称的，都不是发文文号
      - 发文文号示例：津财农〔2024〕95号、洛碛人大〔2019〕4号、石船人发〔2020〕22号
  步骤2：如果找到完整的发文文号（包含单位简称+年份+编号+号），再检查内容是否涉及政策制定、法规条文等政策性内容
  步骤3：只有同时满足"有完整发文文号"和"有政策性内容"两个条件，才能归类为类型3
  步骤4：如果只有政策性内容但没有完整发文文号（只有日期或编号，没有单位简称+年份+编号+号的完整格式），必须归类为"办文材料信息"（类型2）
  步骤5：如果既没有政策性内容也没有发文文号，归类为"办文材料信息"（类型2）

文档文件名：
{file_name}

文档内容：
{content}

请仔细分析文档的文件名、内容特征、格式特征、文档类型（如函、通知、报告等）和用途，准确判断文档类型。文件名中可能包含重要信息（如发文文号、文件类型、单位名称等），请充分利用文件名信息辅助分类。

【分类前必须检查】：
1. 首先检查是否为办会材料信息（类型1）：
   - 检查文档标题、文件名或核心内容中是否包含"会议"、"会议通知"、"会议纪要"、"会议方案"、"会议安排"等关键词
   - 如果找到会议相关关键词，且文档内容涉及会议的组织、通知、记录等活动，归类为办会材料信息（类型1）
   - 如果文档标题或文件名明确包含"会议通知"、"会议纪要"、"会议方案"等，应归类为办会材料信息（类型1）

2. 然后检查是否为政策文件信息（类型3）：
   - 仔细搜索文档内容和文件名，查找是否包含完整的发文文号
   - 发文文号必须包含：发文单位简称+年份（〔〕或[]括起来）+编号+号
   - 例如：津财农〔2024〕95号、洛碛人大〔2019〕4号
   - 注意：单独的日期（如2024年、2024-12-25）、单独的编号（如第95号）、只有年份和编号但没有单位简称的，都不是发文文号
   - 如果找不到完整的发文文号（缺少单位简称、年份、编号或"号"字中的任何一项），无论内容多么像政策文件，都必须归类为"办文材料信息"（类型2）
   - 只有明确找到完整的发文文号（包含单位简称+年份+编号+号）且内容涉及政策，才能归类为类型3

请严格按照以上规则进行分类，不要因为文档内容涉及政策或文档中有日期、编号就归类为类型3，必须先确认有完整的发文文号（包含单位简称+年份+编号+号）。
请只返回类型编号（1、2或3），不要返回其他任何内容。"""
    
    def __init__(self):
        """初始化分类器"""
        if not OPENAI_API_KEY:
            raise ValueError("OPENAI_API_KEY 未设置")
        
        self.client = OpenAI(
            api_key=OPENAI_API_KEY,
            base_url=OPENAI_BASE_URL,
            timeout=REQUEST_TIMEOUT,
        )
        self.model = MODEL_NAME
    
    def classify(self, content: str, file_name: str = "") -> Optional[str]:
        """
        对文档进行分类
        
        Args:
            content: 文档内容
            file_name: 文件名（用于日志）
            
        Returns:
            文档类型名称（办会材料信息、办文材料信息、政策文件信息），失败返回None
        """
        if not content:
            logger.warning(f"文档内容为空: {file_name}")
            return None
        
        # 格式化提示词，包含文件名和内容
        prompt = self.CLASSIFICATION_PROMPT.format(
            file_name=file_name if file_name else "未知文件名",
            content=content
        )
        
        for attempt in range(MAX_RETRIES):
            try:
                response = self.client.chat.completions.create(
                    model=self.model,
                    messages=[
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.3,  # 降低温度以提高分类准确性
                )
                
                result = response.choices[0].message.content.strip()
                
                # 提取数字（可能包含其他字符）
                doc_type_num = None
                for char in result:
                    if char in "123":
                        doc_type_num = char
                        break
                
                if doc_type_num and doc_type_num in DOC_TYPE_MAPPING:
                    doc_type = DOC_TYPE_MAPPING[doc_type_num]
                    logger.info(f"文档分类成功: {file_name} -> {doc_type}")
                    return doc_type
                else:
                    logger.warning(f"分类结果无效: {file_name}, 返回: {result}")
                    if attempt < MAX_RETRIES - 1:
                        continue
                    return None
                    
            except Exception as e:
                logger.error(f"分类失败 (尝试 {attempt + 1}/{MAX_RETRIES}): {file_name}, 错误: {e}")
                if attempt < MAX_RETRIES - 1:
                    continue
                return None
        
        return None

