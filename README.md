# 文档自动提取关键信息系统

## 功能说明

本系统可以自动处理本地文档（Word、PDF），识别文档类型，提取关键信息，并将结果存储到对应的Excel表格中。

系统主要功能包括：
1. **文档分类**：自动识别文档类型（办会材料信息、办文材料信息、政策文件信息）
2. **信息提取**：从文档中提取关键信息字段
3. **问答对生成**：基于政策文件自动生成问答对，符合政府用词用语习惯，同时便于老百姓理解

## 快速开始

### 1. 环境准备

```bash
# 激活 conda 环境
conda activate big-data-doc-auto-shell

# 确保已安装依赖
pip install -e .
```

### 2. 配置检查

确保 `.env` 文件已正确配置：
- `OPENAI_API_KEY`: API密钥
- `OPENAI_BASE_URL`: API地址
- `MODEL_NAME`: 模型名称
- `MAX_WORKERS`: 并发处理线程数（可选，默认5，可根据API限流情况调整）

### 3. 运行程序

#### 3.1 文档处理（提取关键信息）

```bash
python main.py
```

#### 3.2 生成政策问答对

在完成文档处理后，可以基于政策文件生成问答对：

```bash
python generate_qa.py
```

该程序会：
- 读取 `output/4政策文件信息.xlsx` 中的政策记录
- 为每个政策生成 10 个问答对
- 将问答对保存到 `output/5政策问答对.xlsx`

#### 3.3 批量上传文件

批量并行上传文件到服务器：

```bash
python upload_files.py
```

该程序会：
- 递归扫描指定目录及其所有子目录下的文件（支持 .xlsx, .xls, .docx, .doc, .pdf）
- 并发上传文件到指定接口
- 上传成功后自动删除本地文件
- 失败的文件会进行重试（可配置重试次数）

**配置说明**（在 `.env` 文件中配置）：
- `UPLOAD_DIR`: 待上传文件夹路径（默认：`data`）
- `UPLOAD_URL`: 上传接口URL（必填，例如：`https://example.com/easy-db-web/api/open/excelUpload`）
- `UPLOAD_TOKEN`: 上传token（必填）
- `UPLOAD_MAX_WORKERS`: 并发上传数量（默认：5）
- `UPLOAD_MAX_RETRIES`: 上传失败重试次数（默认：3）

#### 3.4 文件去重

对 `output/` 目录中的文件进行去重，基于文件 hash 值识别重复文件：

```bash
python deduplicate.py
```

该程序会：
- 扫描 `output/` 目录下三个分类文件夹（办会材料信息、办文材料信息、政策文件信息）中的所有文档文件
- 计算每个文件的 MD5 hash 值
- 识别重复文件（hash 值相同的文件）
- **保留策略**：保留最早的文件（按修改时间），删除其他重复文件
- 自动删除 Excel 文件中对应的行数据（根据 `PolicyFileName` 字段匹配）
- 如果删除的是政策文件，还会删除 `5政策问答对.xlsx` 中关联的问答对（根据 `ID` 字段匹配）

**注意事项**：
- 执行前建议先备份 `output/` 目录
- 程序会显示将要删除的文件列表，需要确认后才会执行删除操作
- 所有操作都会记录到 `deduplicate.log` 日志文件中

#### 3.5 文件名规范化

规范化 `output/` 目录中的文件名，处理空格和括号问题：

```bash
python normalize_filenames.py
```

该程序会：
- 扫描 `output/` 目录下三个分类文件夹（办会材料信息、办文材料信息、政策文件信息）中的所有文档文件
- 检查文件名是否需要规范化
- **规范化规则**：
  - 空格、Tab等空白字符 → 下划线 `_`
  - 英文圆括号 `()` → 中文圆括号 `（）`
- 重命名文件
- 自动更新 Excel 文件中对应的 `PolicyFileName` 字段值

**注意事项**：
- 执行前建议先备份 `output/` 目录
- 程序会显示将要处理的文件列表，需要确认后才会执行操作
- 所有操作都会记录到 `normalize_filenames.log` 日志文件中
- 如果目标文件名已存在，会跳过重命名以避免覆盖

## 使用说明

1. 将待处理的文档放入 `data/` 目录
2. 运行 `python main.py`
3. 程序会自动：
   - 扫描 `data/` 目录下的所有 Word 和 PDF 文件（**按创建时间倒序排列，最新的文件优先处理**）
   - **并发处理**：使用线程池并发处理多个文件（默认5个并发线程，可通过 `MAX_WORKERS` 环境变量配置）
   - 使用 LLM 对文档进行分类
   - 提取关键信息
   - 将结果保存到 `output/` 目录对应的 Excel 文件中（线程安全）

### 并发处理说明

系统已实现并发处理功能，可以显著提升处理速度：

- **默认并发数**：5个线程（可通过环境变量 `MAX_WORKERS` 调整）
- **线程安全**：Excel文件写入使用锁机制，确保数据安全
- **性能提升**：对于大量文档，并发处理可以显著缩短总处理时间

**调整并发数**：
- 在 `.env` 文件中设置 `MAX_WORKERS=10`（例如设置为10个并发线程）
- 注意：并发数过高可能导致API限流，建议根据API服务商的限制合理设置

## 输出文件

处理后的数据会保存在 `output/` 目录：
- `2办会材料信息.xlsx` - 办会材料
- `3办文材料信息.xlsx` - 办文材料
- `4政策文件信息.xlsx` - 政策文件
- `5政策问答对.xlsx` - 政策问答对（需运行 `generate_qa.py` 生成）

## 日志

- `processing.log` - 文档处理日志（main.py）
- `qa_generation.log` - 问答对生成日志（generate_qa.py）
- `upload.log` - 文件上传日志（upload_files.py）
- `deduplicate.log` - 文件去重日志（deduplicate.py）
- `normalize_filenames.log` - 文件名规范化日志（normalize_filenames.py）

## 政策问答对生成说明

### 功能特点

- **自动生成**：基于政策文件信息自动生成 10 个问答对
- **风格平衡**：符合政府用词用语习惯，同时便于老百姓理解
- **内容全面**：涵盖政策适用范围、申请条件、办理流程、所需材料等多个方面

### 使用前提

在运行 `generate_qa.py` 之前，需要先运行 `main.py` 处理文档，确保 `output/4政策文件信息.xlsx` 文件已生成并包含政策记录。

### 问答对字段说明

- **XH**：序号（自动递增）
- **ID**：关联的政策文件ID
- **SourceDepartment**：来源部门（责任部门或发布单位）
- **Problem**：问题（老百姓关心的实际问题）
- **Answer**：答案（基于政策文件的准确回答）
- **PolicyName**：政策名称
- **DocumentNumber**：发文文号
- **Fields**：涉及领域
- **Remarks**：备注

